# -*- ruby -*-

require 'rubygems'
require './lib/ixtlan/version.rb'

require 'spec'
require 'spec/rake/spectask'
require 'pathname'
require 'yard'

desc "Run specs"
Spec::Rake::SpecTask.new('spec')

task :clean do
  sh "rm -r pkg"
end

desc 'Package as a gem.'
task :package do
  sh "gem build rack_datamapper.gemspec" 
  sh "mkdir -p pkg"
  sh "mv rack-datamapper-*.gem pkg"
end

desc 'Install the package as a gem.'
task :install => [:clean, :package] do
  gem = Dir['pkg/*.gem'].first
  sh "gem install --local #{gem} --no-ri --no-rdoc"
end

desc 'generate rails using all generators and run the specs'
task :integration_tests => [:spec, :install] do
  require 'datamapper4rails/integration_test'
  tests = Datamapper4Rails::IntegrationTest.new do |t|
    t.directory = 'temp'
    ENV['GWT'] = "true"
    t.rails_template = 'ixtlan_rails_templates.rb'
    t.generate "ixtlan_datamapper_model name name:string"
    t.generate "ixtlan_datamapper_rspec_model domain name:string"
    t.generate "ixtlan_datamapper_rspec_scaffold player name:string"
    t.generate "gwt_ixtlan_datamapper_rspec_scaffold word name:string"
   end
   tests.command("mvn clean integration-test")
end

YARD::Rake::YardocTask.new

module Datamapper4Rails
  class IntegrationTest
    def command(command)
      FileUtils.cd(@directory) do
      unless system("#{command}")
        puts
        puts "error in: #{command}"
        exit 1
      end
    end
    end
  end
end

# vim: syntax=Ruby
